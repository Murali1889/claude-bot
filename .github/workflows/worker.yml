name: Claude Bot Worker

on:
  repository_dispatch:
    types: [claude-fix]

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  fix-code:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Log Incoming Request
        run: |
          echo "========================================================"
          echo "Received fix request"
          echo "Target Repo: ${{ github.event.client_payload.repo }}"
          echo "Issue: #${{ github.event.client_payload.issue_number }}"
          echo "Description: ${{ github.event.client_payload.description }}"
          echo "========================================================"

      - name: Clone Target Repository
        env:
          GH_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
        run: |
          git clone https://x-access-token:${GH_TOKEN}@github.com/${{ github.event.client_payload.repo }}.git target-repo
          cd target-repo
          git config user.name "Claude Bot"
          git config user.email "claude-bot@users.noreply.github.com"

      - name: Create Branch
        run: |
          cd target-repo
          BRANCH_NAME="claude-fix/issue-${{ github.event.client_payload.issue_number }}"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Step 1 - Create Codebase Map
        working-directory: target-repo
        run: |
          if [ ! -f "code_base.md" ]; then
            echo "Creating codebase map..."
            claude "You are documenting a codebase.

            Create a file called 'code_base.md' with:
            - Project overview
            - Tech stack
            - Directory structure
            - Key files and their purposes

            Use the Write tool to create code_base.md."
          fi

      - name: Step 2 - Analyze the Issue
        working-directory: target-repo
        env:
          DESCRIPTION: ${{ github.event.client_payload.description }}
          FILE_HINT: ${{ github.event.client_payload.file_hint }}
        run: |
          claude "You are analyzing a bug/feature request.

          ## Problem
          $DESCRIPTION

          ## File Hint
          $FILE_HINT

          ## Task
          1. Read code_base.md
          2. Explore relevant files
          3. Create 'claude_analysis.md' with:
             - Status: CHANGES_REQUIRED or NO_CHANGES_NEEDED
             - Summary
             - Files to modify
             - Implementation plan

          Use the Write tool to create claude_analysis.md. DO NOT modify source code yet."

      - name: Check if Changes Needed
        id: check
        working-directory: target-repo
        run: |
          if grep -q "NO_CHANGES_NEEDED" claude_analysis.md 2>/dev/null; then
            echo "changes_needed=false" >> $GITHUB_OUTPUT
          else
            echo "changes_needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Step 3 - Implement Changes
        if: steps.check.outputs.changes_needed == 'true'
        working-directory: target-repo
        env:
          DESCRIPTION: ${{ github.event.client_payload.description }}
        run: |
          claude "You are implementing a fix.

          ## Problem
          $DESCRIPTION

          ## Instructions
          1. Read claude_analysis.md for the plan
          2. Read code_base.md for codebase context
          3. Implement the changes using Edit/Write tools
          4. Keep changes minimal

          Make the actual code changes now."

      - name: Commit and Push
        if: steps.check.outputs.changes_needed == 'true'
        working-directory: target-repo
        env:
          GH_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
          DESCRIPTION: ${{ github.event.client_payload.description }}
        run: |
          # Remove temp files from commit
          rm -f claude_analysis.md code_base.md 2>/dev/null || true

          # Check if there are changes
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git add -A
          git commit -m "fix: ${DESCRIPTION:0:50}

          Fixes #${{ github.event.client_payload.issue_number }}

          Generated by Claude Bot"

          git push -u origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.check.outputs.changes_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
          DESCRIPTION: ${{ github.event.client_payload.description }}
        run: |
          cd target-repo

          PR_URL=$(gh pr create \
            --title "Fix: ${DESCRIPTION:0:60}" \
            --body "## Automated Fix by Claude Bot

          **Issue:** #${{ github.event.client_payload.issue_number }}

          **Description:** $DESCRIPTION

          ---
          *This PR was created automatically by [Claude Bot](https://github.com/Muralivvrsn/claude-bot)*" \
            --base main \
            --head "$BRANCH_NAME")

          echo "PR_URL=$PR_URL" >> $GITHUB_ENV

      - name: Comment on Issue (Success)
        if: steps.check.outputs.changes_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.client_payload.issue_number }} \
            --repo ${{ github.event.client_payload.repo }} \
            --body "âœ… I've created a PR to fix this issue: $PR_URL

          Please review the changes and let me know if you need any adjustments!"

      - name: Comment on Issue (No Changes)
        if: steps.check.outputs.changes_needed == 'false'
        env:
          GH_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
        run: |
          ANALYSIS=$(cat target-repo/claude_analysis.md 2>/dev/null || echo "Could not determine changes needed")

          gh issue comment ${{ github.event.client_payload.issue_number }} \
            --repo ${{ github.event.client_payload.repo }} \
            --body "ğŸ” I analyzed this issue but no code changes are needed.

          **Analysis:**
          $ANALYSIS"
